#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

BUILD_DIR=$1

echo '-----> Rewriting libffi.pc'
echo "$PKG_CONFIG_PATH"
echo `ls $BUILD_DIR/.apt/usr/lib/x86_64-linux-gnu`

mkdir -p $BUILD_DIR/.heroku/vendor/lib/pkgconfig
cp -av $BUILD_DIR/.apt/usr/lib/x86_64-linux-gnu/libffi*.so $BUILD_DIR/.heroku/vendor/lib
sed -e "s%/usr%/app/.apt/usr%" -e "s%Cflags:%Cflags: -I\${includedir}%" -e "s%Libs:%Libs: -L\${libdir}%" < $BUILD_DIR/.apt/usr/lib/x86_64-linux-gnu/pkgconfig/libffi.pc > $BUILD_DIR/.heroku/vendor/lib/pkgconfig/libffi.pc
cp -av $BUILD_DIR/.apt/usr/include/x86_64-linux-gnu/ffi*.h $BUILD_DIR/.heroku/python/include/python2.7
